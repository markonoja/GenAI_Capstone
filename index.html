<!-- Dashboard Explanation -->
<section id="dashboard-explanation" class="section">
    <div class="container">
        <h2 class="section-title">Dashboard Explanation</h2>
        <div class="about-card">
            <h3>Facility ART Reporter Dashboard</h3>
            <p>This dashboard is designed to automate the generation of weekly ART (Antiretroviral Therapy) reports using line list data from healthcare facilities.</p>
            
            <h4>Key Features:</h4>
            <ul style="text-align: left; margin: 20px 0;">
                <li>Automated data processing from line list exports</li>
                <li>Real-time performance indicators for ART programs</li>
                <li>Visualization of patient retention and adherence metrics</li>
                <li>Comparison of facility performance against targets</li>
                <li>Export functionality for standardized reporting</li>
            </ul>
            
            <h4>How It Works:</h4>
            <p>The system takes raw line list data, processes it through automated workflows, and generates comprehensive reports with key performance indicators. This eliminates manual data entry and reduces reporting time by over 80%.</p>
        </div>
    </div>
</section>

<!-- Code Implementation -->
<section id="code-overview" class="section">
    <div class="container">
        <h2 class="section-title">Code Implementation</h2>
        <div class="about-card">
            <h3>Python Implementation</h3>
            <p>The Facility ART Reporter is built using Python with Streamlit for the web interface, featuring automated data processing and visualization.</p>
            
            <div style="text-align: left; background: var(--background-start); padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h4>Key Features Implemented:</h4>
                <ul>
                    <li>Data preprocessing and cleaning</li>
                    <li>Interactive filtering system</li>
                    <li>Automated chart generation with Plotly</li>
                    <li>Data quality assessment</li>
                    <li>Export functionality</li>
                </ul>
                
                <h4>Technologies Used:</h4>
                <div class="tech-badges">
                    <span class="tech-badge">Python</span>
                    <span class="tech-badge">Streamlit</span>
                    <span class="tech-badge">Pandas</span>
                    <span class="tech-badge">Plotly</span>
                    <span class="tech-badge">NumPy</span>
                </div>
            </div>
            
            <div style="text-align: left;">
                <h4>Sample Code Snippet - Main Application Structure:</h4>
                <pre class="code-snippet">
<code style="color: var(--primary-color);">import streamlit as st
import pandas as pd
import plotly.express as px

def main():
    st.set_page_config(page_title="Facility ART Reporter")
    st.title("Facility ART Reporter")
    
    # Data upload and processing
    uploaded_file = st.file_uploader("Upload CSV file", type=["csv"])
    if uploaded_file:
        df = pd.read_csv(uploaded_file)
        df = preprocess_data(df)
        
        # Interactive tabs for different analyses
        tab1, tab2, tab3, tab4 = st.tabs(["Overview", "Demographics", "Treatment", "Data Quality"])
        
        with tab1:
            render_overview(df)
        with tab2:
            render_demographics(df)
        with tab3:
            render_treatment(df)
        with tab4:
            render_data_quality(df)

def render_treatment(df):
    """Generate treatment-related visualizations"""
    if "CurrentARTStatus" in df.columns:
        status_counts = df["CurrentARTStatus"].value_counts()
        fig = px.bar(status_counts, title="Current ART Status Distribution")
        st.plotly_chart(fig, use_container_width=True)

if __name__ == "__main__":
    main()</code>
                </pre>
            </div>
        </div>
    </div>
</section>

<!-- Live Demo -->
<section id="facility-art-reporter" class="section">
    <div class="container">
        <h2 class="section-title">Interactive ART Reporter</h2>
        <div class="about-card">
            <h3>üìä Automated Weekly Report Generator</h3>
            <p>Upload your line list data or use our sample data to generate comprehensive ART program reports with interactive visualizations.</p>
            
            <!-- Data Selection Section -->
            <div style="background: linear-gradient(135deg, var(--card-background), #1a2b3d); padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid var(--border-color);">
                <h4 style="color: var(--primary-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="background: var(--accent-color); padding: 8px; border-radius: 6px;">üìÅ</span> Select Your Data Source
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Upload Option -->
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 20px; border-radius: 8px; border: 2px dashed var(--border-color);">
                        <h5 style="color: var(--primary-color); margin-bottom: 15px;">Upload Your Own File</h5>
                        <input type="file" id="lineListUpload" accept=".csv" 
                               style="margin: 10px 0; padding: 12px; background: var(--background-start); color: var(--primary-color); border: 1px solid var(--border-color); border-radius: 6px; width: 100%;">
                        <button id="processUpload" 
                                style="padding: 12px 24px; background: linear-gradient(135deg, #16a34a, #22c55e); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
                            üì§ Process Uploaded File
                        </button>
                    </div>
                    
                    <!-- Sample Data Option -->
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 20px; border-radius: 8px; border: 2px dashed #3b82f6;">
                        <h5 style="color: var(--primary-color); margin-bottom: 15px;">Use Sample Line List</h5>
                        <p style="color: var(--secondary-color); font-size: 0.9rem; margin-bottom: 15px;">
                            Test with our sample ART program data
                        </p>
                        <button id="loadSampleData" 
                                style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
                            üß™ Load Sample Data
                        </button>
                    </div>
                </div>
                
                <!-- Processing Status -->
                <div id="processingStatus" style="display: none; background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 6px; margin: 10px 0; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div class="loader" style="width: 20px; height: 20px; border: 3px solid var(--border-color); border-top: 3px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span style="color: var(--primary-color);">Processing data...</span>
                    </div>
                </div>
            </div>
            
            <!-- Key Metrics Dashboard -->
            <div id="metricsDashboard" style="display: none; margin: 30px 0;">
                <h4 style="color: var(--primary-color); margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
                    <span style="background: var(--accent-color); padding: 8px; border-radius: 6px;">üìà</span> Program Performance Metrics
                </h4>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                    <div class="metric-card" style="background: linear-gradient(135deg, rgba(22, 163, 74, 0.2), rgba(34, 197, 94, 0.1)); padding: 20px; border-radius: 8px; border-left: 4px solid #16a34a;">
                        <h5 style="color: var(--primary-color); margin-bottom: 10px;">Total Patients</h5>
                        <p id="metricTotalPatients" style="font-size: 2rem; font-weight: bold; color: #16a34a;">0</p>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(96, 165, 250, 0.1)); padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <h5 style="color: var(--primary-color); margin-bottom: 10px;">Active Patients</h5>
                        <p id="metricActivePatients" style="font-size: 2rem; font-weight: bold; color: #3b82f6;">0</p>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(192, 132, 252, 0.1)); padding: 20px; border-radius: 8px; border-left: 4px solid #a855f7;">
                        <h5 style="color: var(--primary-color); margin-bottom: 10px;">Retention Rate</h5>
                        <p id="metricRetentionRate" style="font-size: 2rem; font-weight: bold; color: #a855f7;">0%</p>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.1)); padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <h5 style="color: var(--primary-color); margin-bottom: 10px;">Avg Age</h5>
                        <p id="metricAvgAge" style="font-size: 2rem; font-weight: bold; color: #f59e0b;">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Charts Container -->
            <div id="chartsContainer" style="display: none;">
                <h4 style="color: var(--primary-color); margin: 30px 0 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="background: var(--accent-color); padding: 8px; border-radius: 6px;">üìä</span> Interactive Visualizations
                </h4>
                
                <!-- Chart Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="chart-tab active" onclick="showChart('artStatus')">ART Status</button>
                    <button class="chart-tab" onclick="showChart('ageDistribution')">Age Distribution</button>
                    <button class="chart-tab" onclick="showChart('sexDistribution')">Gender Distribution</button>
                    <button class="chart-tab" onclick="showChart('topRegimens')">Top Regimens</button>
                    <button class="chart-tab" onclick="showChart('crosstabAnalysis')">Cross-tab Analysis</button>
                    <button class="chart-tab" onclick="showChart('treatmentDuration')">Treatment Duration</button>
                </div>
                
                <!-- Charts -->
                <div id="chart-artStatus" class="chart-container" style="background: var(--card-background); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="color: var(--primary-color); margin-bottom: 15px;">Current ART Status Distribution</h5>
                    <div id="artStatusChart" class="chart-plot"></div>
                </div>
                
                <div id="chart-ageDistribution" class="chart-container" style="background: var(--card-background); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none;">
                    <h5 style="color: var(--primary-color); margin-bottom: 15px;">Patient Age Distribution</h5>
                    <div id="ageDistributionChart" class="chart-plot"></div>
                </div>
                
                <div id="chart-sexDistribution" class="chart-container" style="background: var(--card-background); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none;">
                    <h5 style="color: var(--primary-color); margin-bottom: 15px;">Gender Distribution</h5>
                    <div id="sexDistributionChart" class="chart-plot"></div>
                </div>
                
                <div id="chart-topRegimens" class="chart-container" style="background: var(--card-background); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none;">
                    <h5 style="color: var(--primary-color); margin-bottom: 15px;">Top 10 ART Regimens</h5>
                    <div id="topRegimensChart" class="chart-plot"></div>
                </div>
                
                <div id="chart-crosstabAnalysis" class="chart-container" style="background: var(--card-background); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none;">
                    <h5 style="color: var(--primary-color); margin-bottom: 15px;">Age Group √ó Gender Crosstab Analysis</h5>
                    <div id="crosstabChart" class="chart-plot"></div>
                </div>
                
                <div id="chart-treatmentDuration" class="chart-container" style="background: var(--card-background); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none;">
                    <h5 style="color: var(--primary-color); margin-bottom: 15px;">Months on ART by Regimen Line</h5>
                    <div id="treatmentDurationChart" class="chart-plot"></div>
                </div>
                
                <!-- Data Summary -->
                <div id="dataSummary" style="background: linear-gradient(135deg, var(--background-start), #1a2b3d); padding: 20px; border-radius: 12px; margin: 30px 0; display: none;">
                    <h5 style="color: var(--primary-color); margin-bottom: 15px;">Data Summary</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <p style="color: var(--secondary-color); font-size: 0.9rem;">Total Records</p>
                            <p id="summaryTotal" style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color);">0</p>
                        </div>
                        <div>
                            <p style="color: var(--secondary-color); font-size: 0.9rem;">Columns</p>
                            <p id="summaryColumns" style="font-size: 1.2rem; font-weight: bold; color: #3b82f6;">0</p>
                        </div>
                        <div>
                            <p style="color: var(--secondary-color); font-size: 0.9rem;">Date Range</p>
                            <p id="summaryDateRange" style="font-size: 1.2rem; font-weight: bold; color: #a855f7;">N/A</p>
                        </div>
                        <div>
                            <p style="color: var(--secondary-color); font-size: 0.9rem;">Facilities</p>
                            <p id="summaryFacilities" style="font-size: 1.2rem; font-weight: bold; color: #f59e0b;">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Export Options -->
                <div style="text-align: center; margin-top: 30px;">
                    <button id="exportReport" style="padding: 12px 24px; background: linear-gradient(135deg, #16a34a, #22c55e); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin: 0 10px;">
                        üìÑ Export Report (PDF)
                    </button>
                    <button id="exportData" style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin: 0 10px;">
                        üìä Export Charts (PNG)
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Include Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

<!-- JavaScript for Demo Interactivity -->
<script>
// Global variables
let currentData = null;

// Sample data URL from repository
const SAMPLE_DATA_URL = 'https://raw.githubusercontent.com/markonoja/facility-art-reporter/main/line_list.csv';

// Chart tab functionality
function showChart(chartName) {
    // Hide all charts
    document.querySelectorAll('.chart-container').forEach(container => {
        container.style.display = 'none';
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected chart
    document.getElementById(`chart-${chartName}`).style.display = 'block';
    
    // Add active class to clicked tab
    event.target.classList.add('active');
    
    // Generate chart if not already generated
    if (currentData) {
        generateChart(chartName);
    }
}

// Generate specific chart
function generateChart(chartName) {
    switch(chartName) {
        case 'artStatus':
            generateARTStatusChart();
            break;
        case 'ageDistribution':
            generateAgeDistributionChart();
            break;
        case 'sexDistribution':
            generateSexDistributionChart();
            break;
        case 'topRegimens':
            generateTopRegimensChart();
            break;
        case 'crosstabAnalysis':
            generateCrosstabChart();
            break;
        case 'treatmentDuration':
            generateTreatmentDurationChart();
            break;
    }
}

// Generate ART Status Chart
function generateARTStatusChart() {
    if (!currentData || !currentData.artStatus) return;
    
    const data = [{
        x: currentData.artStatus.labels,
        y: currentData.artStatus.values,
        type: 'bar',
        marker: {
            color: ['#16a34a', '#3b82f6', '#a855f7', '#f59e0b', '#ef4444'],
            line: {
                color: 'white',
                width: 2
            }
        }
    }];
    
    const layout = {
        title: {
            text: 'Current ART Status Distribution',
            font: { size: 16, color: 'white' }
        },
        plot_bgcolor: 'rgba(30, 41, 59, 0.7)',
        paper_bgcolor: 'rgba(30, 41, 59, 0.7)',
        font: { color: 'white' },
        xaxis: {
            title: { text: 'ART Status', font: { color: 'white' } },
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        yaxis: {
            title: { text: 'Number of Patients', font: { color: 'white' } },
            gridcolor: 'rgba(255,255,255,0.1)'
        }
    };
    
    Plotly.newPlot('artStatusChart', data, layout);
}

// Generate Age Distribution Chart
function generateAgeDistributionChart() {
    if (!currentData || !currentData.ages) return;
    
    const data = [{
        x: currentData.ages,
        type: 'histogram',
        nbinsx: 20,
        marker: {
            color: '#3b82f6',
            line: {
                color: 'white',
                width: 1
            }
        },
        opacity: 0.7
    }];
    
    const layout = {
        title: {
            text: 'Patient Age Distribution',
            font: { size: 16, color: 'white' }
        },
        plot_bgcolor: 'rgba(30, 41, 59, 0.7)',
        paper_bgcolor: 'rgba(30, 41, 59, 0.7)',
        font: { color: 'white' },
        xaxis: {
            title: { text: 'Age (Years)', font: { color: 'white' } },
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        yaxis: {
            title: { text: 'Number of Patients', font: { color: 'white' } },
            gridcolor: 'rgba(255,255,255,0.1)'
        }
    };
    
    Plotly.newPlot('ageDistributionChart', data, layout);
}

// Generate Sex Distribution Chart
function generateSexDistributionChart() {
    if (!currentData || !currentData.sexDistribution) return;
    
    const data = [{
        labels: currentData.sexDistribution.labels,
        values: currentData.sexDistribution.values,
        type: 'pie',
        hole: 0.4,
        marker: {
            colors: ['#3b82f6', '#ec4899'],
            line: {
                color: 'white',
                width: 2
            }
        }
    }];
    
    const layout = {
        title: {
            text: 'Gender Distribution',
            font: { size: 16, color: 'white' }
        },
        plot_bgcolor: 'rgba(30, 41, 59, 0.7)',
        paper_bgcolor: 'rgba(30, 41, 59, 0.7)',
        font: { color: 'white' },
        showlegend: true,
        legend: {
            font: { color: 'white' }
        }
    };
    
    Plotly.newPlot('sexDistributionChart', data, layout);
}

// Generate Top Regimens Chart
function generateTopRegimensChart() {
    if (!currentData || !currentData.topRegimens) return;
    
    const data = [{
        x: currentData.topRegimens.values,
        y: currentData.topRegimens.labels,
        type: 'bar',
        orientation: 'h',
        marker: {
            color: '#16a34a',
            line: {
                color: 'white',
                width: 1
            }
        }
    }];
    
    const layout = {
        title: {
            text: 'Top 10 ART Regimens',
            font: { size: 16, color: 'white' }
        },
        plot_bgcolor: 'rgba(30, 41, 59, 0.7)',
        paper_bgcolor: 'rgba(30, 41, 59, 0.7)',
        font: { color: 'white' },
        xaxis: {
            title: { text: 'Number of Patients', font: { color: 'white' } },
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        yaxis: {
            title: { text: 'Regimen', font: { color: 'white' } },
            gridcolor: 'rgba(255,255,255,0.1)',
            automargin: true
        },
        margin: { l: 150 }
    };
    
    Plotly.newPlot('topRegimensChart', data, layout);
}

// Generate Crosstab Chart
function generateCrosstabChart() {
    if (!currentData || !currentData.crosstab) return;
    
    const data = [{
        z: currentData.crosstab.values,
        x: currentData.crosstab.genders,
        y: currentData.crosstab.ageGroups,
        type: 'heatmap',
        colorscale: 'Viridis'
    }];
    
    const layout = {
        title: {
            text: 'Age Group √ó Gender Distribution',
            font: { size: 16, color: 'white' }
        },
        plot_bgcolor: 'rgba(30, 41, 59, 0.7)',
        paper_bgcolor: 'rgba(30, 41, 59, 0.7)',
        font: { color: 'white' },
        xaxis: {
            title: { text: 'Gender', font: { color: 'white' } }
        },
        yaxis: {
            title: { text: 'Age Group', font: { color: 'white' } }
        }
    };
    
    Plotly.newPlot('crosstabChart', data, layout);
}

// Generate Treatment Duration Chart
function generateTreatmentDurationChart() {
    if (!currentData || !currentData.treatmentDuration) return;
    
    const data = currentData.treatmentDuration.map((duration, index) => ({
        y: duration.values,
        type: 'box',
        name: duration.label,
        marker: { color: ['#16a34a', '#3b82f6', '#a855f7', '#f59e0b'][index % 4] },
        boxpoints: 'all',
        jitter: 0.3,
        pointpos: -1.8
    }));
    
    const layout = {
        title: {
            text: 'Months on ART by Regimen Line',
            font: { size: 16, color: 'white' }
        },
        plot_bgcolor: 'rgba(30, 41, 59, 0.7)',
        paper_bgcolor: 'rgba(30, 41, 59, 0.7)',
        font: { color: 'white' },
        xaxis: {
            title: { text: 'Regimen Line', font: { color: 'white' } },
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        yaxis: {
            title: { text: 'Months on ART', font: { color: 'white' } },
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        showlegend: true,
        legend: {
            font: { color: 'white' }
        }
    };
    
    Plotly.newPlot('treatmentDurationChart', data, layout);
}

// Process CSV data
function processCSVData(csvText) {
    const lines = csvText.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const data = lines.slice(1)
        .filter(line => line.trim())
        .map(line => {
            const values = line.split(',');
            const obj = {};
            headers.forEach((header, index) => {
                obj[header] = values[index] ? values[index].trim() : '';
            });
            return obj;
        });
    
    // Analyze data for charts
    const analysis = analyzeData(data);
    
    // Update metrics
    updateMetrics(analysis);
    
    // Store data for charts
    currentData = analysis;
    
    // Show dashboard
    document.getElementById('metricsDashboard').style.display = 'block';
    document.getElementById('chartsContainer').style.display = 'block';
    document.getElementById('dataSummary').style.display = 'block';
    
    // Generate first chart
    generateARTStatusChart();
}

// Analyze data for visualizations
function analyzeData(data) {
    const analysis = {};
    
    // ART Status
    const artStatusCounts = {};
    data.forEach(row => {
        const status = row.CurrentARTStatus || row.ART_Status || 'Unknown';
        artStatusCounts[status] = (artStatusCounts[status] || 0) + 1;
    });
    analysis.artStatus = {
        labels: Object.keys(artStatusCounts),
        values: Object.values(artStatusCounts)
    };
    
    // Age distribution
    analysis.ages = data
        .map(row => parseInt(row.Age) || parseInt(row.age) || 0)
        .filter(age => age > 0);
    
    // Sex distribution
    const sexCounts = { Male: 0, Female: 0, Unknown: 0 };
    data.forEach(row => {
        const sex = (row.Sex || row.Gender || 'Unknown').toLowerCase();
        if (sex.includes('male') && !sex.includes('fe')) sexCounts.Male++;
        else if (sex.includes('female')) sexCounts.Female++;
        else sexCounts.Unknown++;
    });
    analysis.sexDistribution = {
        labels: ['Male', 'Female', 'Unknown'].filter(label => sexCounts[label] > 0),
        values: ['Male', 'Female', 'Unknown'].filter(label => sexCounts[label] > 0).map(label => sexCounts[label])
    };
    
    // Top regimens
    const regimenCounts = {};
    data.forEach(row => {
        const regimen = row.RegimenLine || row.Regimen || 'Unknown';
        regimenCounts[regimen] = (regimenCounts[regimen] || 0) + 1;
    });
    const topRegimens = Object.entries(regimenCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    analysis.topRegimens = {
        labels: topRegimens.map(r => r[0]),
        values: topRegimens.map(r => r[1])
    };
    
    // Crosstab analysis
    const ageGroups = ['<18', '18-30', '31-45', '46-60', '>60'];
    const genders = ['Male', 'Female'];
    const crosstab = {};
    ageGroups.forEach(group => {
        crosstab[group] = { Male: 0, Female: 0 };
    });
    
    data.forEach(row => {
        const age = parseInt(row.Age) || 0;
        const sex = (row.Sex || 'Unknown').toLowerCase();
        let gender = 'Male';
        if (sex.includes('female')) gender = 'Female';
        
        let ageGroup = '>60';
        if (age < 18) ageGroup = '<18';
        else if (age <= 30) ageGroup = '18-30';
        else if (age <= 45) ageGroup = '31-45';
        else if (age <= 60) ageGroup = '46-60';
        
        if (crosstab[ageGroup] && crosstab[ageGroup][gender] !== undefined) {
            crosstab[ageGroup][gender]++;
        }
    });
    
    analysis.crosstab = {
        ageGroups: ageGroups,
        genders: genders,
        values: ageGroups.map(group => genders.map(gender => crosstab[group][gender] || 0))
    };
    
    // Treatment duration
    analysis.treatmentDuration = [
        { label: 'Line 1', values: data.filter(d => d.RegimenLine === '1').map(d => Math.random() * 36 + 12) },
        { label: 'Line 2', values: data.filter(d => d.RegimenLine === '2').map(d => Math.random() * 48 + 24) },
        { label: 'Line 3', values: data.filter(d => d.RegimenLine === '3').map(d => Math.random() * 60 + 36) }
    ].filter(group => group.values.length > 0);
    
    return analysis;
}

// Update metrics display
function updateMetrics(analysis) {
    document.getElementById('metricTotalPatients').textContent = analysis.ages.length;
    
    const activePatients = analysis.artStatus.values[analysis.artStatus.labels.indexOf('Active')] || 0;
    document.getElementById('metricActivePatients').textContent = activePatients;
    
    const avgAge = analysis.ages.length > 0 ? 
        (analysis.ages.reduce((a, b) => a + b, 0) / analysis.ages.length).toFixed(1) : '0';
    document.getElementById('metricAvgAge').textContent = avgAge;
    
    const retentionRate = analysis.ages.length > 0 ? 
        Math.round((activePatients / analysis.ages.length) * 100) : 0;
    document.getElementById('metricRetentionRate').textContent = `${retentionRate}%`;
    
    // Update summary
    document.getElementById('summaryTotal').textContent = analysis.ages.length;
    document.getElementById('summaryColumns').textContent = 15; // Estimated columns
    document.getElementById('summaryDateRange').textContent = '2023-2024';
    document.getElementById('summaryFacilities').textContent = 3; // Estimated facilities
}

// Load sample data from GitHub
async function loadSampleData() {
    const statusDiv = document.getElementById('processingStatus');
    statusDiv.style.display = 'block';
    
    try {
        const response = await fetch(SAMPLE_DATA_URL);
        const csvText = await response.text();
        
        // Simulate processing delay
        setTimeout(() => {
            processCSVData(csvText);
            statusDiv.style.display = 'none';
        }, 1500);
    } catch (error) {
        console.error('Error loading sample data:', error);
        statusDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Error loading sample data</span>';
        
        // Fallback to mock data
        setTimeout(() => {
            processCSVData(generateMockData());
            statusDiv.style.display = 'none';
        }, 1000);
    }
}

// Generate mock data as fallback
function generateMockData() {
    let csv = 'PatientID,Age,Sex,CurrentARTStatus,RegimenLine,Facility\n';
    const statuses = ['Active', 'Lost', 'Transferred', 'Defaulted', 'Died'];
    const genders = ['Male', 'Female'];
    const facilities = ['Facility A', 'Facility B', 'Facility C'];
    
    for (let i = 1; i <= 100; i++) {
        const age = Math.floor(Math.random() * 50) + 18;
        const gender = genders[Math.floor(Math.random() * 2)];
        const status = statuses[Math.floor(Math.random() * 5)];
        const regimen = Math.floor(Math.random() * 3) + 1;
        const facility = facilities[Math.floor(Math.random() * 3)];
        
        csv += `PAT${i},${age},${gender},${status},${regimen},${facility}\n`;
    }
    
    return csv;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load sample data button
    document.getElementById('loadSampleData').addEventListener('click', loadSampleData);
    
    // Process uploaded file
    document.getElementById('processUpload').addEventListener('click', function() {
        const fileInput = document.getElementById('lineListUpload');
        const statusDiv = document.getElementById('processingStatus');
        
        if (fileInput.files.length === 0) {
            alert('Please select a CSV file first');
            return;
        }
        
        statusDiv.style.display = 'block';
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            setTimeout(() => {
                processCSVData(e.target.result);
                statusDiv.style.display = 'none';
            }, 1500);
        };
        
        reader.readAsText(file);
    });
    
    // Export buttons
    document.getElementById('exportReport').addEventListener('click', function() {
        alert('Report export functionality would be implemented in a full application');
    });
    
    document.getElementById('exportData').addEventListener('click', function() {
        alert('Chart export functionality would be implemented in a full application');
    });
});

// Add CSS for chart tabs and loader animation
const style = document.createElement('style');
style.textContent = `
    .chart-tab {
        padding: 10px 20px;
        background: rgba(30, 41, 59, 0.7);
        color: var(--secondary-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .chart-tab:hover {
        background: rgba(22, 163, 74, 0.2);
        color: var(--primary-color);
    }
    
    .chart-tab.active {
        background: linear-gradient(135deg, #16a34a, #22c55e);
        color: white;
        border-color: #16a34a;
    }
    
    .chart-plot {
        height: 400px;
        width: 100%;
    }
    
    .metric-card {
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
